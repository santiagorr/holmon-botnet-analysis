<composition id="stage2_plus_aggregation">
  <general>
    <clock type="wall" />
  </general>

  <install>
    <threadpool id="src_thread" num_threads="1"/>
    
    <block id="src" type="PcapSource" invocation="async" threadpool="src_thread">	  
      <params>
        <!--source type='live' name='eth0'/-->
        <source type='trace' name='/home/mirko/dns_trace/short_dns_trace.pcap'/>
      </params>
    </block>

      <block id="filter" type="PacketFilter" invocation="direct"> 
        <params>
          <l3_protocol number="2048">
            <filter_mode behavior="accept"/>
          </l3_protocol>
          <l4_protocol number="17">
            <filter_mode behavior="accept"/>
          </l4_protocol>
          <src_port number='53'>
            <filter_mode behavior='accept'/>
          </src_port>
        </params>
      </block>

      <block id="mapper" type="DNSMapper" invocation="direct"> 
        <params/>
      </block>

      <block id="mapfilter" type="DNSMappingFilter" invocation="direct"> 
        <params>
          <complete_flush val = "3600"/>
          <table_memory val = "600"/>
        </params>
      </block>

    <block id="aggregator" type="DNSMappingAggregator" invocation="direct" threadpool="aggregator_thread"> 
      <params>
          <time_bin_aggregation val = "240"/>
          <time_bin_printout val = "240"/>
          <query_threshold val = "0"/>
		  <enable_txt_output val = "true"/>
		  <output_file_prefix val = "/home/mirko/dns_output/aggregation_"/>
		  <enable_socket_output val = "true"/>
		  <server_ip val = "192.168.1.79"/>
		  <server_port val = "50007"/>
      </params>
    </block>

    <block id="analyzer" type="DNSMappingAnalyzer" invocation="direct"> 
      <params>
        <time_bin_merge val = "120"/>
        <time_bin_split_cleanup val = "240"/>
        <time_bin_printout val = "3600"/>
        <suspicious_file_prefix val = "/home/mirko/dns_output/suspicious_"/>
        <dump_file_prefix val = "/home/mirko/dns_output/dump_"/>
        <load_file val = "/home/mirko/dns_output/dump_final.txt"/>
        <load_config val = "false"/>
	    <tld_names_file val = "/home/mirko/dns_trace/data/effective_tld_names.dat"/>
	    <geoip_file val = "/home/mirko/dns_trace/data/GeoIPASNum.dat"/>
        <max_cluster_size val = "30"/>
        <max_num_clusters val = "20"/>
        <clustering_threshold val = "0.7"/>
        <domain_count_threshold val = "0.5"/>
      </params>
    </block>

    <block id="maliciousAnalyzerD" type="DNSSuspiciousMappingAnalyzerD" invocation="direct"> 
      <params>
		  <geoip_file val = "/home/mirko/dns_trace/data/GeoIPASNum.dat"/>
		  <enable_txt_output val = "true"/>
          <malicious_file_prefix val = "/home/mirko/dns_output/malicious_file.txt"/>
		  <update_cnt_thr val = "1000"/>
		  <input_table_memory val = "86400"/>
		  <output_table_memory val = "43200"/>
		  <enable_socket_output val = "true"/>
		  <server_ip val = "192.168.1.79"/>
		  <server_port val = "60007"/>
		  <min_num_domains val = "1"/>
		  <min_num_ips val = "1"/>
		  <min_num_ases val = "1"/>
      </params>
    </block>

    <block id="maliciousAnalyzer" type="DNSSuspiciousMappingAnalyzer" invocation="direct"> 
      <params>
		  <geoip_file val = "/home/mirko/dns_trace/data/GeoIPASNum.dat"/>
		  <enable_txt_output val = "true"/>
          <malicious_file_prefix val = "/home/mirko/dns_output/malicious_"/>
		  <enable_socket_output val = "true"/>
		  <server_ip val = "192.168.1.79"/>
		  <server_port val = "60007"/>
		  <min_num_domains val = "1"/>
		  <min_num_ips val = "1"/>
		  <min_num_ases val = "1"/>
      </params>
    </block>

    <connection src_block="src" src_gate="source_out" dst_block="filter" dst_gate="in_pkt"/>
    <connection src_block="filter" src_gate="out_pkt" dst_block="mapper" dst_gate="in"/>
    <connection src_block="mapper" src_gate="out" dst_block="mapfilter" dst_gate="in"/>
    <connection src_block="mapfilter" src_gate="out" dst_block="aggregator" dst_gate="in_msg"/>
    <connection src_block="mapfilter" src_gate="out" dst_block="analyzer" dst_gate="in_msg"/>
    <connection src_block="analyzer" src_gate="out_msg1" dst_block="maliciousAnalyzer" dst_gate="in_msg"/>
    <connection src_block="analyzer" src_gate="out_msg2" dst_block="maliciousAnalyzer" dst_gate="in_msg"/>

  </install>
</composition>
